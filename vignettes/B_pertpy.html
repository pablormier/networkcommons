<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vignette B: Pertpy bridging to NetworkCommons &mdash; NetworkCommons alpha documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=2155bac8" />

  
    <link rel="shortcut icon" href="../_static/nc_logo.svg"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=1f169f65"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Vignette A: recursive propagation with MOON" href="A_moon.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../contents.html">
            
              <img src="../_static/nc_logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.5.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Main</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Bridging the gap between data, methods and knowledge in the network inference field</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Details</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../datasets.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods.html">Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmarks.html">Evaluation strategies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contribution guidelines</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guidelines/landing.html">General guidelines for contribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guidelines/guide_1_data.html">Contribution’s guideline: Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guidelines/guide_2_methods.html">Contribution’s guideline: Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guidelines/guide_3_eval.html">Contribution’s guideline: Evaluation strategies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vignettes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="1_quickstart.html">Vignette 1: Introduction to NetworkCommons</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_multiple_methods.html">Vignette 2: Using multiple methods to infer the networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_evaluation_offt_path.html">Vignette 3: Evaluating methods under two scenarios: offtarget recovery and pathway activity</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_evaluation_decryptm.html">Vignette 4: Sensitive response to drug perturbation using phosphoproteomics</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_cptac_phosphoactivity.html">Vignette 5: Multi-omics validation - Recovery of dysregulated kinases in response to cancer mutations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional resources</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="A_moon.html">Vignette A: recursive propagation with MOON</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Vignette B: Pertpy bridging to NetworkCommons</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#1.-Processing-with-pertpy">1. Processing with pertpy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#2.-TF-activity-estimation-with-decoupler-py">2. TF activity estimation with decoupler-py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#3.-Network-inference-with-NetworkCommons">3. Network inference with NetworkCommons</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../contents.html">NetworkCommons</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../contents.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Vignette B: Pertpy bridging to NetworkCommons</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/saezlab/networkcommons/blob/master/docs/src/vignettes/B_pertpy.ipynb" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Vignette-B:-Pertpy-bridging-to-NetworkCommons">
<h1>Vignette B: Pertpy bridging to NetworkCommons<a class="headerlink" href="#Vignette-B:-Pertpy-bridging-to-NetworkCommons" title="Link to this heading"></a></h1>
<p>In this vignette, we showcase how the resources from pertpy can be used with NetworkCommons. Here, we will use part of the vignette <a class="reference external" href="https://pertpy.readthedocs.io/en/latest/tutorials/notebooks/mcfarland_use_case.html">Use-case: Deconvoluting drug responses in cancer cell lines</a>, available in the <a class="reference external" href="https://pertpy.readthedocs.org">pertpy documentation</a>. This dataset contains single-cell RNA-seq perturbational profiles from 172 cancer cell lines treated with 13 drugs. Due to computational
power constrains, we will only showcase this with one cell line and one dataset. However, this can be expanded</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pertpy</span> <span class="k">as</span> <span class="nn">pt</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">networkcommons</span> <span class="k">as</span> <span class="nn">nc</span>
</pre></div>
</div>
</div>
</div>
<section id="1.-Processing-with-pertpy">
<h2>1. Processing with pertpy<a class="headerlink" href="#1.-Processing-with-pertpy" title="Link to this heading"></a></h2>
<p>This section was taken from the pertpy documentation, <a class="reference external" href="https://pertpy.readthedocs.io/en/latest/tutorials/notebooks/mcfarland_use_case.html">Use-case: Deconvoluting drug responses in cancer cell lines</a>. Please refer to this for further details.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">mcfarland_2020</span><span class="p">()</span>
<span class="n">adata</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">write_h5ad</span><span class="p">(</span>
    <span class="s2">&quot;adata.h5ad&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="s2">&quot;adata.h5ad&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;Navitoclax&#39;,
 &#39;BRD3379&#39;,
 &#39;AZD5591&#39;,
 &#39;Taselisib&#39;,
 &#39;Everolimus&#39;,
 &#39;Idasanutlin&#39;,
 &#39;Bortezomib&#39;,
 &#39;sgLACZ&#39;,
 &#39;sgGPX4-1&#39;,
 &#39;control&#39;,
 &#39;Trametinib&#39;,
 &#39;sgOR2J2&#39;,
 &#39;Afatinib&#39;,
 &#39;Dabrafenib&#39;,
 &#39;sgGPX4-2&#39;,
 &#39;Gemcitabine&#39;,
 &#39;JQ1&#39;,
 &#39;Prexasertib&#39;]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">filter_genes</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">min_cells</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;raw_counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Metadata annotation</span>
<span class="n">cl_metadata</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">CellLine</span><span class="p">()</span>
<span class="n">cl_metadata</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">query_id</span><span class="o">=</span><span class="s2">&quot;DepMap_ID&quot;</span><span class="p">,</span>
    <span class="n">reference_id</span><span class="o">=</span><span class="s2">&quot;ModelID&quot;</span><span class="p">,</span>
    <span class="n">fetch</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CellLineName&quot;</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span><span class="p">,</span> <span class="s2">&quot;OncotreePrimaryDisease&quot;</span><span class="p">,</span> <span class="s2">&quot;SangerModelID&quot;</span><span class="p">,</span> <span class="s2">&quot;OncotreeLineage&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">moa_metadata</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">Moa</span><span class="p">()</span>
<span class="n">moa_metadata</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">query_id</span><span class="o">=</span><span class="s2">&quot;perturbation&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Add control annotations</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;moa&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Control&quot;</span> <span class="k">if</span> <span class="n">pert</span> <span class="o">==</span> <span class="s2">&quot;control&quot;</span> <span class="k">else</span> <span class="n">moa</span> <span class="k">for</span> <span class="n">moa</span><span class="p">,</span> <span class="n">pert</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;moa&quot;</span><span class="p">],</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">])]</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Control&quot;</span> <span class="k">if</span> <span class="n">pert</span> <span class="o">==</span> <span class="s2">&quot;control&quot;</span> <span class="k">else</span> <span class="n">target</span> <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">pert</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">])]</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;moa&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cl_metadata</span><span class="o">.</span><span class="n">annotate_from_gdsc</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">query_id</span><span class="o">=</span><span class="s2">&quot;SangerModelID&quot;</span><span class="p">,</span>
    <span class="n">reference_id</span><span class="o">=</span><span class="s2">&quot;sanger_model_id&quot;</span><span class="p">,</span>
    <span class="n">query_perturbation</span><span class="o">=</span><span class="s1">&#39;perturbation&#39;</span><span class="p">,</span>
    <span class="n">gdsc_dataset</span><span class="o">=</span><span class="s2">&quot;gdsc_1&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;ln_ic50_GDSC1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;ln_ic50&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">cl_metadata</span><span class="o">.</span><span class="n">annotate_from_gdsc</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">query_id</span><span class="o">=</span><span class="s2">&quot;SangerModelID&quot;</span><span class="p">,</span>
    <span class="n">reference_id</span><span class="o">=</span><span class="s2">&quot;sanger_model_id&quot;</span><span class="p">,</span>
    <span class="n">query_perturbation</span><span class="o">=</span><span class="s1">&#39;perturbation&#39;</span><span class="p">,</span>
    <span class="n">gdsc_dataset</span><span class="o">=</span><span class="s2">&quot;gdsc_2&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;ln_ic50_GDSC2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;ln_ic50&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">del</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;ln_ic50&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_dabrafenib</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;control&quot;</span><span class="p">,</span> <span class="s2">&quot;Dabrafenib&quot;</span><span class="p">])]</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_dabrafenib</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="s2">&quot;adata_dabrafenib.h5ad&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">subset_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">adata_dabrafenib</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;SangerModelID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">subset_cells</span>
</pre></div>
</div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;SIDM00759&#39;, &#39;SIDM00582&#39;, &#39;SIDM00963&#39;, &#39;SIDM01150&#39;, &#39;SIDM00143&#39;,
       &#39;SIDM00756&#39;, &#39;SIDM01060&#39;, &#39;SIDM00139&#39;, &#39;SIDM01167&#39;, &#39;SIDM01026&#39;],
      dtype=&#39;&lt;U32&#39;)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logfc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">adata_dabrafenib</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>

<span class="k">for</span> <span class="n">cell_line</span> <span class="ow">in</span> <span class="n">subset_cells</span><span class="p">:</span>

    <span class="n">subset</span> <span class="o">=</span> <span class="n">adata_dabrafenib</span><span class="p">[</span><span class="n">adata_dabrafenib</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;SangerModelID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_line</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">subset</span><span class="o">.</span><span class="n">n_obs</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span> <span class="c1">#Threshold from the McFarland paper</span>
        <span class="k">continue</span>
    <span class="k">if</span> <span class="s2">&quot;Dabrafenib&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subset</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="k">continue</span>

    <span class="n">edgr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">PyDESeq2</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">design</span><span class="o">=</span><span class="s2">&quot;~perturbation&quot;</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s2">&quot;raw_counts&quot;</span><span class="p">)</span>
    <span class="n">edgr</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="n">res_df</span> <span class="o">=</span> <span class="n">edgr</span><span class="o">.</span><span class="n">test_contrasts</span><span class="p">(</span><span class="n">edgr</span><span class="o">.</span><span class="n">contrast</span><span class="p">(</span><span class="s2">&quot;perturbation&quot;</span><span class="p">,</span> <span class="s2">&quot;control&quot;</span><span class="p">,</span> <span class="s2">&quot;Dabrafenib&quot;</span><span class="p">))</span>
    <span class="n">res_df</span> <span class="o">=</span> <span class="n">res_df</span><span class="p">[[</span><span class="s2">&quot;variable&quot;</span><span class="p">,</span> <span class="s2">&quot;log_fc&quot;</span><span class="p">]]</span>
    <span class="n">res_df</span> <span class="o">=</span> <span class="n">res_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span>
    <span class="n">res_df</span> <span class="o">=</span> <span class="n">res_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">adata_dabrafenib</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>

    <span class="n">logfc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cell_line</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_df</span><span class="p">[</span><span class="s2">&quot;log_fc&quot;</span><span class="p">]</span>

<span class="n">logfc_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output/logfc_df_dabrafenib.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logfc_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>RP11-34P13.7</th>
      <th>AL627309.1</th>
      <th>AP006222.2</th>
      <th>RP4-669L17.10</th>
      <th>RP11-206L10.3</th>
      <th>RP11-206L10.2</th>
      <th>RP11-206L10.9</th>
      <th>FAM87B</th>
      <th>LINC00115</th>
      <th>FAM41C</th>
      <th>...</th>
      <th>MT-ND6</th>
      <th>MT-CYB</th>
      <th>AC145212.1</th>
      <th>MGC39584</th>
      <th>AC011043.1</th>
      <th>AL592183.1</th>
      <th>AC011841.1</th>
      <th>AL354822.1</th>
      <th>PNRC2-1</th>
      <th>SRSF10-1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>SIDM01150</th>
      <td>-0.029041</td>
      <td>-0.154688</td>
      <td>0.007570</td>
      <td>0.135863</td>
      <td>0.080412</td>
      <td>0.347878</td>
      <td>0.346763</td>
      <td>0.000000</td>
      <td>-0.148709</td>
      <td>-0.343955</td>
      <td>...</td>
      <td>0.366750</td>
      <td>-0.100324</td>
      <td>0.011169</td>
      <td>0.132036</td>
      <td>-0.025371</td>
      <td>0.145605</td>
      <td>0.013151</td>
      <td>0.025349</td>
      <td>-0.126633</td>
      <td>-0.186471</td>
    </tr>
    <tr>
      <th>SIDM00143</th>
      <td>0.000000</td>
      <td>0.294966</td>
      <td>0.046804</td>
      <td>-0.218813</td>
      <td>0.497196</td>
      <td>0.000000</td>
      <td>-0.218851</td>
      <td>0.000000</td>
      <td>0.439098</td>
      <td>-0.302195</td>
      <td>...</td>
      <td>0.400622</td>
      <td>0.121451</td>
      <td>-0.291270</td>
      <td>0.000000</td>
      <td>0.483729</td>
      <td>0.086145</td>
      <td>0.328663</td>
      <td>0.168367</td>
      <td>-0.006578</td>
      <td>0.451708</td>
    </tr>
    <tr>
      <th>SIDM01060</th>
      <td>0.043288</td>
      <td>0.000000</td>
      <td>-0.162589</td>
      <td>0.065901</td>
      <td>0.027507</td>
      <td>-0.033283</td>
      <td>0.000590</td>
      <td>0.000000</td>
      <td>-0.502486</td>
      <td>-0.351066</td>
      <td>...</td>
      <td>0.224724</td>
      <td>0.005616</td>
      <td>-0.017290</td>
      <td>0.000000</td>
      <td>-0.198974</td>
      <td>-0.399949</td>
      <td>0.000000</td>
      <td>0.131691</td>
      <td>0.000000</td>
      <td>-0.250337</td>
    </tr>
    <tr>
      <th>SIDM01167</th>
      <td>0.000000</td>
      <td>0.158182</td>
      <td>0.484159</td>
      <td>0.047778</td>
      <td>0.047758</td>
      <td>0.000000</td>
      <td>-0.186445</td>
      <td>-0.102564</td>
      <td>0.546340</td>
      <td>0.195960</td>
      <td>...</td>
      <td>0.089615</td>
      <td>0.063865</td>
      <td>0.063088</td>
      <td>0.000000</td>
      <td>-0.326881</td>
      <td>0.000977</td>
      <td>0.000000</td>
      <td>0.114601</td>
      <td>0.000000</td>
      <td>-0.475517</td>
    </tr>
  </tbody>
</table>
<p>4 rows × 21805 columns</p>
</div></div>
</div>
</section>
<section id="2.-TF-activity-estimation-with-decoupler-py">
<h2>2. TF activity estimation with decoupler-py<a class="headerlink" href="#2.-TF-activity-estimation-with-decoupler-py" title="Link to this heading"></a></h2>
<p>Now that we have the gene changes in response to the perturbation, we can perform TF activity estimation with decoupler and CollecTRI. This scores will be the input for the network contextualization methods from NetworkCommons.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">decoupler</span> <span class="k">as</span> <span class="nn">dc</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">get_collectri</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:root:Downloading data from `https://omnipathdb.org/queries/enzsub?format=json`
INFO:root:Downloading data from `https://omnipathdb.org/queries/interactions?format=json`
INFO:root:Downloading data from `https://omnipathdb.org/queries/complexes?format=json`
INFO:root:Downloading data from `https://omnipathdb.org/queries/annotations?format=json`
INFO:root:Downloading data from `https://omnipathdb.org/queries/intercell?format=json`
INFO:root:Downloading data from `https://omnipathdb.org/about?format=text`
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf_acts</span><span class="p">,</span> <span class="n">pvals</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">run_ulm</span><span class="p">(</span><span class="n">logfc_df</span><span class="p">,</span> <span class="n">net</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf_acts</span>
</pre></div>
</div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ABL1</th>
      <th>AEBP1</th>
      <th>AHR</th>
      <th>AHRR</th>
      <th>AIP</th>
      <th>AIRE</th>
      <th>AP1</th>
      <th>APEX1</th>
      <th>AR</th>
      <th>ARID1A</th>
      <th>...</th>
      <th>ZNF382</th>
      <th>ZNF384</th>
      <th>ZNF395</th>
      <th>ZNF410</th>
      <th>ZNF436</th>
      <th>ZNF699</th>
      <th>ZNF76</th>
      <th>ZNF804A</th>
      <th>ZNF91</th>
      <th>ZXDC</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>SIDM01150</th>
      <td>0.080080</td>
      <td>-1.631165</td>
      <td>1.822143</td>
      <td>-0.486594</td>
      <td>-0.783931</td>
      <td>-0.844352</td>
      <td>1.723601</td>
      <td>-1.519310</td>
      <td>-0.344363</td>
      <td>1.623128</td>
      <td>...</td>
      <td>-4.238011</td>
      <td>1.965072</td>
      <td>-2.004019</td>
      <td>0.069187</td>
      <td>2.652415</td>
      <td>-0.182054</td>
      <td>-1.793975</td>
      <td>-0.143599</td>
      <td>1.938493</td>
      <td>-0.277062</td>
    </tr>
    <tr>
      <th>SIDM00143</th>
      <td>-1.332259</td>
      <td>1.592115</td>
      <td>1.183483</td>
      <td>0.799785</td>
      <td>1.025860</td>
      <td>0.468413</td>
      <td>4.497127</td>
      <td>-1.430149</td>
      <td>2.600641</td>
      <td>2.156102</td>
      <td>...</td>
      <td>-0.789468</td>
      <td>3.996778</td>
      <td>-1.028295</td>
      <td>-0.517214</td>
      <td>0.598231</td>
      <td>1.087119</td>
      <td>0.778563</td>
      <td>-0.599900</td>
      <td>1.412452</td>
      <td>-2.276532</td>
    </tr>
    <tr>
      <th>SIDM01060</th>
      <td>-0.652209</td>
      <td>-2.475549</td>
      <td>-1.580986</td>
      <td>1.089401</td>
      <td>-1.944108</td>
      <td>0.399068</td>
      <td>-5.066813</td>
      <td>-2.765601</td>
      <td>-0.934723</td>
      <td>-0.981179</td>
      <td>...</td>
      <td>1.715413</td>
      <td>-0.158227</td>
      <td>1.480932</td>
      <td>0.409427</td>
      <td>-0.044302</td>
      <td>-0.413981</td>
      <td>-0.048804</td>
      <td>-2.692391</td>
      <td>1.406787</td>
      <td>-0.253700</td>
    </tr>
    <tr>
      <th>SIDM01167</th>
      <td>-1.334910</td>
      <td>0.017429</td>
      <td>-2.367893</td>
      <td>0.813763</td>
      <td>2.198922</td>
      <td>-0.660442</td>
      <td>-2.465387</td>
      <td>-1.764444</td>
      <td>-2.983476</td>
      <td>1.955569</td>
      <td>...</td>
      <td>0.219701</td>
      <td>-0.641184</td>
      <td>-0.172258</td>
      <td>-0.653510</td>
      <td>1.087562</td>
      <td>2.267288</td>
      <td>-1.447545</td>
      <td>-0.400557</td>
      <td>1.555596</td>
      <td>-0.400194</td>
    </tr>
  </tbody>
</table>
<p>4 rows × 735 columns</p>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">measurements</span> <span class="o">=</span> <span class="n">tf_acts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;SIDM01060&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">25</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="3.-Network-inference-with-NetworkCommons">
<h2>3. Network inference with NetworkCommons<a class="headerlink" href="#3.-Network-inference-with-NetworkCommons" title="Link to this heading"></a></h2>
<p>Now that we have scores for upstream and downstream layers, we can perform network inference with NetworkCommons. For the sake of simplicity and just for demonstration purposes, we will only use the shortest path approach.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">network</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">get_omnipath</span><span class="p">()</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">network_from_df</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;BRAF&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shortest_path_network</span><span class="p">,</span> <span class="n">shortest_path_list</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">methods</span><span class="o">.</span><span class="n">run_shortest_paths</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">measurements</span><span class="p">)</span>
<span class="n">shortest_sc_network</span><span class="p">,</span> <span class="n">shortest_sc_list</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">methods</span><span class="o">.</span><span class="n">run_sign_consistency</span><span class="p">(</span><span class="n">shortest_path_network</span><span class="p">,</span> <span class="n">shortest_path_list</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">measurements</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">visualizer</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">NetworkXVisualizer</span><span class="p">(</span><span class="n">shortest_sc_network</span><span class="p">)</span>
<span class="n">visualizer</span><span class="o">.</span><span class="n">visualize_network</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">measurements</span><span class="p">,</span> <span class="n">network_type</span><span class="o">=</span><span class="s1">&#39;sign_consistent&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/vignettes_B_pertpy_33_0.svg" src="../_images/vignettes_B_pertpy_33_0.svg" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="A_moon.html" class="btn btn-neutral float-left" title="Vignette A: recursive propagation with MOON" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, NetworkCommons developers.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>